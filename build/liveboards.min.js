"use strict";angular.module("br.liveboards",["brLiveboardsFilters"]).config(function(a){a.interceptors.push("loadingStatusInterceptor")}).directive("brLiveboards",["$http",function(a){return{restrict:"A",template:'<div class="brLiveboards"><div ng-if="!selectedStation" class="selectStation"><p ng-if="stations">Select a station</p><select ng-if="stations" ng-model="selectedStation" ng-options="s.name for s in stations" ng-change="update(selectedStation)"></select></div><div ng-if="showLoader" class="loader"></div><div ng-if="errorMessage" class="error">{{errorMessage}}</div><div ng-if="liveBoard" class="liveBoard"><div class="stationData"><h1>{{liveBoard.location.name}}</h1></div><table class="departures"><thead><tr><th colspan="5">{{now}}</th></tr></thead><tbody><tr class="departure" ng-repeat="departure in liveBoard.departures"><td class="time">{{departure.time | timeFilter}}</td><td class="direction">{{departure.direction}}</td><td class="type">{{departure.vehicle | vehicleTypeFilter}}</td><td class="platform">{{departure.platform.name}}</td><td ng-if="!departure.delay" class="delay">&nbsp;</td><td ng-if="departure.delay" class="delay">+{{departure.delay | delayFilter}}</td></tr></tbody></table></div></div>{{foobar.value}}',scope:{station:"="},controller:function(b){b.selectedStation=angular.isUndefined(b.station)?!1:!0,b.activeStation=!1,b.liveBoard=null,b.showLoader=!1,b.errorMessage="",b.now=(new Date).toLocaleTimeString("be-BE").replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3"),b.$on("loadingStatusActive",function(){b.showLoader=!0}),b.$on("loadingStatusInactive",function(){b.showLoader=!1}),a.get("https://data.irail.be/NMBS/Stations.json").success(function(a){if(b.stations=a.Stations,!angular.isUndefined(b.station)){for(var c=!1,d=0;d<a.Stations.length;++d)if(a.Stations[d].name===b.station){b.update(a.Stations[d]),c=!0;break}c||(b.errorMessage="The selected station does not exist")}}),b.update=function(c){b.selectedStation=c,b.showLoader=!0,a.get(c.departures+".json").success(function(a){a.Liveboard.departures=a.Liveboard.departures.slice(0,20),b.liveBoard=a.Liveboard}).error(function(a,b){console.log(b),console.log(a)})}}}}]).factory("loadingStatusInterceptor",function(a,b){var c=0,d=function(){0===c&&b.$broadcast("loadingStatusActive"),c++},e=function(){c--,0===c&&b.$broadcast("loadingStatusInactive")};return{request:function(b){return d(),b||a.when(b)},response:function(b){return e(),b||a.when(b)},responseError:function(b){return e(),a.reject(b)}}}),angular.module("brLiveboardsFilters",[]).filter("vehicleTypeFilter",function(){return function(a){var b=a.split(".");return b[2].replace(/(\d+)/g,"")}}).filter("timeFilter",function(){return function(a){var b=new Date(1e3*a);return b.toLocaleTimeString("be-BE").replace(/([\d]+:[\d]{2})(:[\d]{2})(.*)/,"$1$3")}}).filter("delayFilter",function(){return function(a){var b=parseInt(a/3600,10)%24,c=parseInt(a/60,10)%60;return(10>b?"0"+b:b)+"h"+(10>c?"0"+c:c)}});